(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{483:function(s,n,a){s.exports=a.p+"assets/img/image-20220909222858406.678434a0.png"},992:function(s,n,a){"use strict";a.r(n);var t=a(6),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"postgresql高可用实战"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postgresql高可用实战"}},[s._v("#")]),s._v(" postgresql高可用实战")]),s._v(" "),n("h2",{attrs:{id:"代理和连接池"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代理和连接池"}},[s._v("#")]),s._v(" 代理和连接池")]),s._v(" "),n("p",[s._v("集群间基于代理和连接池的高可用架构")]),s._v(" "),n("p",[n("img",{attrs:{src:a(483),alt:"image-20220909222858406"}})]),s._v(" "),n("h3",{attrs:{id:"通过haproxy实现代理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#通过haproxy实现代理"}},[s._v("#")]),s._v(" 通过HAProxy实现代理")]),s._v(" "),n("p",[s._v("流行的负载平衡器和代理解决方案。放在应用和数据库之间。")]),s._v(" "),n("p",[s._v("将流量从一个来源分发到一个或者多个目的地")]),s._v(" "),n("p",[s._v("优势：")]),s._v(" "),n("p",[s._v("1、如果有数据库单点故障，可以转移到好的数据节点去。")]),s._v(" "),n("p",[s._v("2、使用副本来提高读取性能")]),s._v(" "),n("h3",{attrs:{id:"haproxy安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#haproxy安装"}},[s._v("#")]),s._v(" HAProxy安装")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装编译环境")]),s._v("\nyum "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" gcc pcre-devel "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" -y\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载并解压haproxy")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -O  http://www.haproxy.org/download/2.2/src/haproxy-2.2.4.tar.gz\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf haproxy-2.2.4.tar.gz\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" haproxy-2.2.4\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译并安装haproxy")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TARGET")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("linux-glibc\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/haproxy\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/lib/haproxy \n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /var/lib/haproxy/stats\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/sbin/haproxy /usr/sbin/haproxy\n\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" haproxy-2.2.4/examples/haproxy.init /etc/init.d/haproxy\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("755")]),s._v(" /etc/init.d/haproxy\nsystemctl daemon-reload\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chkconfig")]),s._v(" haproxy on\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" -r haproxy\nhaproxy -v\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost haproxy-2.2.4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# haproxy -v")]),s._v("\nHA-Proxy version "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.2")]),s._v(".4-de45672 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/09/30 - https://haproxy.org/\nStatus: long-term supported branch - will stop receiving fixes around Q2 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2025")]),s._v(".\nKnown bugs: http://www.haproxy.org/bugs/bugs-2.2.4.html\nRunning on: Linux "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1160.el7.x86_64 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置haproxy.cfg")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/local/etc/haproxy/haproxy.cfg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n#全局配置和默认模块\nglobal\n    maxconn 300\ndefaults\n    log global\n    mode tcp\n    retries 2\n    timeout client 30m\n    timeout connect 4s\n    timeout server 30m\n    timeout check 5s\n#统计信息配置模块\nlisten stats\n    mode http\n    bind *:7000\n    stats enable\n    stats uri /\n#核心配置模块：流复制配置模式。一个master两个slave\nMaster:pg_master_1(替换为ip地址)\nslave:pg_slave_1,pg_slave_2(替换为ip地址)\nlisten postgres_rw\n    bind *:5000\n    \n    option pgsql-check user optima\n    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions\n    balance roundrobin\n    server pg_master_1 pg_master_1:5432 check port 5432\n    server pg_slave_1 pg_slave_1:5432  check port 5432 backup\n    server pg_slave_2 pg_slave_2:5432  check port 5432 backup\nlisten postgres_ro\n    bind *:5001\n    option pgsql-check user optima\n    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions\n    balance roundrobin\n    server pg_master_1 pg_master_1:5432 check port 5432\n    server pg_slave_1 pg_slave_1:5432 check port 5432   weight 100\n    server pg_slave_2 pg_slave_2:5432 check port 5432   weight 100\nEOF")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动")]),s._v("\nsystemctl start haproxy\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br")])]),n("p",[s._v("参数解释：")]),s._v(" "),n("p",[s._v("bind：使用端口")]),s._v(" "),n("p",[s._v("option pgsql-check user optima：运行检测状况")]),s._v(" "),n("p",[s._v("balance：平衡算法")]),s._v(" "),n("p",[s._v("​\troundrobin轮询算法，平均分布")]),s._v(" "),n("p",[s._v("​\tleastconn最少连接优先，优先分配给少的")]),s._v(" "),n("p",[s._v("​\tfirst:第一台满了之后在发给下一台")]),s._v(" "),n("p",[s._v("​\tsource:对源IP进行散列，相同客户端IP始终到达一台服务器")]),s._v(" "),n("h3",{attrs:{id:"pgbouncer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pgbouncer"}},[s._v("#")]),s._v(" PgBouncer")]),s._v(" "),n("p",[s._v("连接池软件，根据配置创建若干Postgresql连接，以先到先得的方式分配给使用者")]),s._v(" "),n("h3",{attrs:{id:"安装pgbouncer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装pgbouncer"}},[s._v("#")]),s._v(" 安装PgBouncer")]),s._v(" "),n("p",[s._v("安装pgbouncer之前需要安装libevent")]),s._v(" "),n("p",[s._v("wget https://pgbouncer.github.io/downloads/files/1.7.2/pgbouncer-1.7.2.tar.gz\nwget http://get.enterprisedb.com/postgresql/postgresql-9.5.1-1-linux-x64.run\nwget https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz")]),s._v(" "),n("p",[s._v("参考安装连接")]),s._v(" "),n("p",[s._v("http://t.zoukankan.com/fangyuan303687320-p-5633097.html")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install -y c-ares-devel openssl-devel libevent-devel make gcc\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tar zxvf libevent-2.0.22-stable.tar.gz\ncd libevent-2.0.22-stable\n./configure --prefix=/user/local/libevent\n\n\ntar zxvf pgbouncer-1.7.2.tar.gz\ncd pgbouncer-1.7.2\n./configure --prefix=/user/local/pgbouncer/ --with-libevent=/user/local/libevent/\nmake \nmake install\ncd ..\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("编译安装pg时候漏掉一部")]),s._v(" "),n("p",[s._v("/usr/local/pgsql/bin/postgres --version")]),s._v(" "),n("p",[s._v("pgbouncer的安装和配置")]),s._v(" "),n("p",[s._v("https://www.cnblogs.com/dbalightyear/p/11234173.html")])])}),[],!1,null,null,null);n.default=e.exports}}]);