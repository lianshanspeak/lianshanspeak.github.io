(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{479:function(s,a,t){s.exports=t.p+"assets/img/864900-20211016151025569-35308221.4f500dd7.png"},480:function(s,a,t){s.exports=t.p+"assets/img/864900-20211016152834553-2071664623.c0010991.png"},481:function(s,a,t){s.exports=t.p+"assets/img/864900-20211016154542270-1831746696.bdbe2f71.png"},482:function(s,a,t){s.exports=t.p+"assets/img/864900-20211016160142255-309603695.308ba2e8.png"},982:function(s,a,t){"use strict";t.r(a);var e=t(6),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"postgresql体系结构概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql体系结构概述"}},[s._v("#")]),s._v(" PostgreSQL体系结构概述")]),s._v(" "),a("h2",{attrs:{id:"postgresql的物理架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql的物理架构"}},[s._v("#")]),s._v(" PostgreSQL的物理架构：")]),s._v(" "),a("p",[s._v("由共享内存、一系列后台进程和数据文件组成")]),s._v(" "),a("h3",{attrs:{id:"一、共享内存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、共享内存"}},[s._v("#")]),s._v(" 一、共享内存")]),s._v(" "),a("p",[s._v("是服务器为数据库缓存和事务日志缓存预留的内存缓存空间\nShared Memory=Shared Buffer + WAL Buffer\nWAL Buffer是用来 临时存储数据库变化的 缓存区域。存储在WAL Buffer中的内容会根据提前定义好的时间点参数要求\n写入到磁盘的WAL文件中。")]),s._v(" "),a("h3",{attrs:{id:"二、进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、进程"}},[s._v("#")]),s._v(" 二、进程")]),s._v(" "),a("p",[s._v("PostgreSQL有四种进程类型\nPostmaster (Daemon) Process（主后台驻留进程）\n主后台驻留进程是PostgreSQL启动时第一个启动的进程。启动时，他会执行恢复、初始化共享内存爱你的运行后台进程操作。\n当有客户端发起链接请求时，它还负责创建后端进程。\nPostmaster进程是其他所有进程的父进程")]),s._v(" "),a("p",[s._v("Background Process（后台进程）\nlogger 将错误信息写到log日志中\ncheckpointer 当检查点出现时，将脏内存块写到数据文件\nwriter 数据文件写进程，周期性的将脏内存块写入文件\nwal writer wal写进程,将WAL缓存写入WAL文件\nAutovacuum launcher 当自动vacuum被启用时，用来派生autovacuum工作进程。autovacuum进程的作用是在需要时自动对膨胀表执行vacuum操作。\narchiver 在归档模式下时，复制WAL文件到特定的路径下。\nstats collector 用来收集数据库统计信息，例如会话执行信息统计（使用pg_stat_activity视图）和表使用信息统计（pg_stat_all_tables视图）")]),s._v(" "),a("p",[s._v("Backend Process（后端进程）\n处理前端用户请求并返回结果。查询运行时需要一些内存结构，就是所谓的本地内存（local memory）。\n本地内存涉及的主要参数有：\nwork_mem：用于排序、位图索引、哈希链接和合并链接操作。默认值为4MB。\nmaintenance_work_mem：用于vacuum和创建索引操作。默认值为64MB。\ntemp_buffers：用于临时表。默认值为8MB。")]),s._v(" "),a("p",[s._v("Client Process（客户端进程）\n客户端进程需要和后端进程配合使用，处理每一个客户链接")]),s._v(" "),a("h3",{attrs:{id:"三、数据分布及文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、数据分布及文件"}},[s._v("#")]),s._v(" 三、数据分布及文件")]),s._v(" "),a("p",[s._v("数据库\n当initdb()命令执行后，template0 , template1 , 和postgres数据库被创建。")]),s._v(" "),a("p",[s._v("template0和template1数据库是创建用户数据库时使用的模版数据库，他们包含系统元数据表。")]),s._v(" "),a("p",[s._v("initdb()刚完成后，template0和template1数据库中的表是一样的。但是template1数据库可以根据用户需要创建对象。")]),s._v(" "),a("p",[s._v("用户数据库是通过克隆template1数据库来创建的；")]),s._v(" "),a("p",[s._v("表空间\ninitdb()后马上创建pg_default和pg_global表空间。")]),s._v(" "),a("p",[s._v("建表时如果没有指定特定的表空间，表默认被存在pg_default表空间中。")]),s._v(" "),a("p",[s._v("用于管理整个数据库集群的表默认被存储在pg_global表空间中。")]),s._v(" "),a("p",[s._v("pg_default表空间的物理位置为$PGDATA\\base目录。")]),s._v(" "),a("p",[s._v("pg_global表空间的物理位置为$PGDATA\\global目录。")]),s._v(" "),a("p",[s._v("一个表空间可以被多个数据库同时使用。此时，每一个数据库都会在表空间路径下创建为一个新的子路径。")]),s._v(" "),a("p",[s._v("创建一个用户表空间会在$PGDATA\\pg_tblspc目录下面创建一个软连接，连接到表空间制定的目录位置")]),s._v(" "),a("p",[s._v("表")]),s._v(" "),a("p",[s._v("每个表有三个数据文件。")]),s._v(" "),a("p",[s._v("一个文件用于存储数据，文件名是表的OID。")]),s._v(" "),a("p",[s._v("一个文件用于管理表的空闲空间，文件名是OID_fsm。")]),s._v(" "),a("p",[s._v("一个文件用于管理表的块是否可见，文件名是OID_vm。")]),s._v(" "),a("p",[s._v("索引没有_vm文件，只有OID和OID_fsm两个文件")]),s._v(" "),a("h2",{attrs:{id:"体系结构图表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#体系结构图表"}},[s._v("#")]),s._v(" 体系结构图表")]),s._v(" "),a("p",[s._v("逻辑结构")]),s._v(" "),a("p",[a("img",{attrs:{src:t(479),alt:"img"}})]),s._v(" "),a("p",[s._v("物理结构")]),s._v(" "),a("p",[a("img",{attrs:{src:t(480),alt:"img"}})]),s._v(" "),a("p",[s._v("tips:")]),s._v(" "),a("p",[s._v("数据库的OID存储在pg_database系统表中；")]),s._v(" "),a("p",[s._v("数据库中，表，索引，序列等对象的OID存储在pg_class中")]),s._v(" "),a("p",[s._v("创建表空间")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[postgres@localhost data]$ mkdir -p /pgdata/10/mytblspc\npostgres=# create tablespace myspc LOCATION '/pgdata/10/mytblspc'\npostgres-# ;\nCREATE TABLESPACE\npostgres=# \\db\n                  List of tablespaces\n    Name    |  Owner   |            Location\n------------+----------+--------------------------------\n myspc      | postgres | /pgdata/10/mytblspc\n pg_default | postgres |\n pg_global  | postgres |\n tbs_mydb   | pguser   | /database/pg10/pg_tbs/tbs_mydb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("创建新的库或者表时，就可以指定表空间")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('postgres=# create table t(id serial primary key,ival int ) Tablespace myspc;\nCREATE TABLE\npostgres=# \\d+ t\n                                                Table "public.t"\n Column |  Type   | Collation | Nullable |            Default            | Storage | Stats target | Description\n--------+---------+-----------+----------+-------------------------------+---------+--------------+-------------\n id     | integer |           | not null | nextval(\'t_id_seq\'::regclass) | plain   |              |\n ival   | integer |           |          |                               | plain   |              |\nIndexes:\n    "t_pkey" PRIMARY KEY, btree (id)\nTablespace: "myspc"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("查看mydb，oid")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("postgres=# select oid,datname from pg_database where datname='mydb';\n  oid  | datname\n-------+---------\n 16388 | mydb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("找到mydb的文件")]),s._v(" "),a("p",[a("img",{attrs:{src:t(481),alt:"img"}})]),s._v(" "),a("p",[s._v("内存结构")]),s._v(" "),a("p",[a("img",{attrs:{src:t(482),alt:"img"}})])])}),[],!1,null,null,null);a.default=n.exports}}]);